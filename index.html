<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
	<title>Crawler</title>
	<link rel="shortcut icon" type="image/x-icon" href="icon.png" />
</head>
<body style="background:#000000">
	<style>
		.box {
			font-family: monospace;
			color: #FFFFFF;
			text-align: center;
			position: fixed;
			top: 50%;
			left: 50%;
			border: 1px solid white;
			overflow: scroll;
		}
		#textinput {
			font-family: monospace;
			background: #000000;
			color: #FFFFFF;
			border: 1px solid white;
			width: 100px;
			position: absolute;
			text-align: center;
			top:90%;
		}
		::-webkit-scrollbar {
			width: 10px;
		}
		::-webkit-scrollbar-track {
			background: #000000; 
		}
		::-webkit-scrollbar-thumb {
			background: #888; 
		}
		::-webkit-scrollbar-thumb:hover {
			background: #555; 
		}
		::-webkit-scrollbar-corner {
			background: #000000;
		}
	</style>
	<center>
		<div id="box" class="box"></div>
		<input id="textinput" type="text" name="textinput">
	</center>
	<script>
		var keyListen = {
			start : function() {
				window.onkeyup = function(e) {
					let key = e.keyCode;
					if (ASCII_KEYS.includes(key)) {
						keyListen.keys.splice(keyListen.keys.indexOf(key), 1);
						if (keyListen.keypresses.includes(key)) {
							keyListen.keypresses[keyListen.keypresses.indexOf(key)+1]();
						}
					}
				};
				window.onkeydown = function(e) {
					let key = e.keyCode;
					if (!keyListen.keys.includes(key) && ASCII_KEYS.includes(key)) {
						keyListen.keys.push(key);
					}
				};
			},
			keys : [],
			keypresses : [],
			scrollWheelOff : function() {
				window.onwheel = function() {
				    return false;
				};
			}
		};
		var ASCII_KEYS = [
			"A", 65, "B", 66, "C", 67,
			"D", 68, "E", 69, "F", 70,
			"G", 71, "H", 72, "I", 73,
			"J", 74, "K", 75, "L", 76,
			"M", 77, "N", 78, "O", 79,
			"P", 80, "Q", 81, "R", 82,
			"S", 83, "T", 84, "U", 85,
			"V", 86, "W", 87, "X", 88,
			"Y", 89, "Z", 90, "a", 97,
			"b", 98, "c", 99, "d", 100,
			"e", 101, "f", 102, "g", 103,
			"h", 104, "i", 105, "j", 106,
			"k", 107, "l", 108, "m", 109,
			"n", 110, "o", 111, "p", 112,
			"q", 113, "r", 114, "s", 115,
			"t", 116, "u", 117, "v", 118,
			"w", 119, "x", 120, "y", 121,
			"z", 122, "ENTER", 13
		];
		function toASCII(character) {
			for (let i = 0; i < ASCII_KEYS.length; i += 2) {
				if (character == ASCII_KEYS[i]) {
					return ASCII_KEYS[i+1];
				}
			}
			return -1;
		}
		function removePressListener(key) {
			keyListen.keypresses.splice(keyListen.keypresses.indexOf(toASCII(key)), 2);
		}
		function addPressListener(key, todo) {
			if (!keyListen.keypresses.includes(toASCII(key))) {
				keyListen.keypresses.push(toASCII(key));
				keyListen.keypresses.push(todo);
			}
		}
		function getKeyDown(key) {
			if (keyListen.keys.includes(toASCII(key))) {
				return true;
			}
			return false;
		}
		function RandomInt(min, max) {
			this.gen = function(min, max) {
				this.val = Math.floor(Math.random() * ((max+1) - min) + min);
			};
			this.gen(min, max);
		}
		function decide(probability) {
			if (new RandomInt(0, 100).val >= probability) {
				return true;
			} else {
				return false;
			}
		}
	</script>
	<script>
		var ROOMS = [
			{
				called : "",
				index : 1,
				level : 0,
				text : "",
				conditions : [],
				words : [["ELABORATE", ""]],
				actions : [],
				entitities : [],
				items : [],
				applications : [],
			}, {
				called : "",
				index : 2,
				level : 0, 
				text : "",
				conditions : [],
				words : [],
				actions : [],
				entitities : [],
				items : [],
				applications : []
			}
		];
		var MOBS = [
			{
				called : "ORC",
				health : 100,
				carries : [[10, 50],["AXE", "IRON CHESTPLATE"]],
				drops : [[50],["AXE"]],
				says : [[[50, 50],["Hello.", "Hi."]],[[50, 40, 10], ["Have at you!", "DIE!!!", "NOTHING"]]],
				attackmodifiers : [[80, 15, 5],[1, 0, 2],[[""], [""], [""]]],
				conditions : ["PEACEFUL"],
				conditionalactions : [["provoked"],["hostile"]],
				probableactions : [[40, 40, 20],["SAY", "HOSTILE", "FLEE"]],
				levels : "01234"
			}, {
			}
		];
		var ITEMS = [
			{
				called : "AXE",
				type : "WEAPON",
				spawnability : 2,
				text : [[],[],[]],
				actions : [[],[],[]]
			}, {
			}
		];
		/*
			ACTION SYNTAX
			# - GOTO ROOM #
			? - APPEND TEXT
			/ - REMOVE word and action from current screen (non repeatable action i.e opening doors
		*/
		var MAP = [[0, ""]];
		var READHAIKUS = [];
		var LEVEL = 0;
		var announced = false;
		var handled = true;
		var INPUT = "";
		var AGAIN = "";
		var LASTDIR = "";
		var SCREEN = {
			called : "ZERO",
			index : 0,
			connects : "",
			level : 0,
			conditions : ["SEEN"],
			objects : [[["DOOR"], ["HAIKU", "WRITING"]], ["Just a door.", "Interesting, that."]],
			text : "<br><b>ZERO</b>",
			words : [["OPEN", "OPEN DOOR", "OPEN THE DOOR"]],
			entities : [],
			items : [],
			actions : ["?-You study the poem for a moment before coninuing.-/-OPEN"],
			applications : []
		}
		var Player = {
			called : "",
			inventory : [],
			
		}
		function append(text) {
			AGAIN = text;
			let screentext = "<br>";
			let boxWidthinDashes = parseInt(document.getElementById("box").style.width)/9;
			for (let i = 0; i <= boxWidthinDashes; i++) {
				screentext += "_";
			}
			screentext +="<br><br>"+text+"<br>";
			SCREEN.text += screentext;
		}
		function use(item) {
			if (SCREEN.applications.indexOf(item) != -1) {
				execute(SCREEM.applications[SCREEN.applications.indexOf(item)]);
			} else {
				append("That does not apply here.");
			}
		}
		function clear() {
			SCREEN.text = "";
		}
		function end() {
			console.log("end");
		}
		function execute(action) {
			let taken = action.split("-");
			for (let i = 0; i < taken.length; i += 2) {
				if (taken[i] == "?") {
					append(taken[i+1]);
				} else if (taken[i] == "/") {
					let wordLocation = SCREEN.words.indexOf(taken[i+1]);
					SCREEN.words.splice(wordLocation, 1);
					SCREEN.actions.splice(wordLocation, 1);
				}
			}
		}
		function haiku() {
			let haikus = [
				"This amourous mind<br>An inadequate vessel<br>A pity to be",
				"You are the hidden<br>The masochist beneath me<br>The only pain left"
			];
			let decided = false;
			let counter = 0;
			while (!decided) {
				let randomNum = new RandomInt(0, haikus.length-1);
				if (READHAIKUS.indexOf(randomNum.val) == -1) {
					READHAIKUS.push(randomNum.val);
					return haikus[randomNum.val];
				} else if (counter == haikus.length) {
					return "ERROR 404 HAIKU NOT FOUND";
				}
				counter++;
			}
		}
		function handle() {
			for (let i = 0; i < SCREEN.words.length; i++) {
				let synonym = false;
				let synonyms = SCREEN.words[i];
				for (let j = 0; j < synonyms.length; j++) {
					if (INPUT == synonyms[j]) {
						execute(SCREEN.actions[i]);
						synonym = true;
						break;
					}
				}
				if (INPUT == SCREEN.words[i]) {
					execute(SCREEN.actions[i]);
					break;
				} else if (INPUT == "HELP") {
					append("no");
					break;
				} else if (INPUT == "CLEAR") {
					clear();
					break;
				} else if (INPUT == "AGAIN") {
					append(AGAIN);
					break;
				} else if (INPUT.substr(0, 7) == "OBSERVE") {
					let indice = -1;
					for (let j = 0; j < SCREEN.objects[0].length; j++) {
						if (SCREEN.objects[0][j].indexOf(INPUT.substr(8, INPUT.length-1)) != -1) {
							indice = j;
							break;
						}
					}
					if (indice != -1) {
						append(SCREEN.objects[1][SCREEN.objects[0][indice].indexOf(INPUT.substr(8, INPUT.length-1))]);
					}
					break;
				} else if (!synonym) {
					append("I don't understand.");
					break;
				}
			}
			if (SCREEN.entities.length > 0) {
				
			}
			handled = true;
		}
		function init() {
			let width = window.innerWidth;
			let height = window.innerHeight;
			document.getElementById("box").style="width: "+(width/2).toString()+"px;"+"height: "+(height/2).toString()+"px;"+"margin-left: -"+(width/4).toString()+"px;"+"margin-top: -"+(height/4).toString()+"px;";
			keyListen.start();
			addPressListener("ENTER", submit);
			append("There, upon the rusted door, t'was etched:<br><br>"+haiku()+"<br>");
			main();
		}
		function main() {
			window.requestAnimationFrame(main);
			document.getElementById("textinput").style="left: "+(window.innerWidth/2-50).toString()+"px;";
			render(SCREEN);
			if (!handled) { handle(); }
		}
		function map() {
			//return bitmap of map
		}
		function render(screen) {
			if (screen.entities.length > 1 && screen.entities.length > 0 && !announced) {
				let showString = "";
				for (let i = 0; i < screen.entities.length; i++) {
					if (i != screen.entities.length-2) {
						showString += screen.entities[i].called+", ";
					} else {
						showString += screen.entities[i].called+", and ";
					}
				}
				append(showString.substring(0, showString.length-2)+" are present here.");
				announced = true;
			} else if (screen.entities.length != 0 && !announced) {
				append(screen.entities[0].called+" is present here.");
				announced = true;
			}
			document.getElementById("box").innerHTML = screen.text;
		}
		function submit() {
			INPUT = document.getElementById("textinput").value.toUpperCase();
			document.getElementById("textinput").value = "";
			handled = false;
		}
		init();
	</script>
</body>
</html>
